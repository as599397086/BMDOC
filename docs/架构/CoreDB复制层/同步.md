使用Raft分布式共识协议，CoreDB自动在主集群上同步复制数据，以便在发生故障时保持数据一致性并避免操作员干预。

## **概念**

许多概念是复制的核心。

**1.故障域**
故障域由一组容易出现相关故障的节点组成。 以下是故障域的示例：

* 可用区或机架Zones or racks
* 区域或数据中心Regions or datacenters
* 云提供商

数据通常跨故障域复制，以便能够应对一个故障域中所有节点的中断。

**2.容错能力**
AiSQL Universe 的容错性 (FT) 是指它在继续保持数据正确性的同时能够承受的最大节点故障数。

**3.复制因子**
AiSQL 跨节点（或故障域）复制数据以容忍故障。 复制因子 (RF) 是 AiSQL Universe 中数据的副本数量。 FT 和 RF 是相关的。 为了实现 k 个节点的 FT，universe必须配置为 (2k + 1) 的 RF。

## **Tile对等体peers**

CoreDB 中的数据复制是在Tile级别上实现的，使用Tile对等体，每个表分片为一组Tile，如下图所示：

![](../../assets/chapter9/25.png)

每个tablet由一组tablet对等体组成，每个tablet都存储属于该tablet的数据的一个副本。 一个Tile有与复制因子一样多的Tile对等体，它们形成一个 Raft 组。 Tile对等点托管在不同的节点上，以允许数据冗余以防止节点故障。 Tile对等体之间的数据复制是高度一致的。

下图描述了属于名为tablet 1的tablet的三个tablet对等点。tablet对等点托管在不同的DBServer上，并形成一个Raft组，用于领导者选举、故障检测和预写日志的复制。

![](../../assets/chapter9/26.png)



**Raft复制**
一旦Tile启动，它就会使用 Raft 协议选举其中一个Tile作为Tile领导者。 Tablet Leader 负责通过将用户发出的写入转换为 CoreDB 的文档存储层来处理面向用户的写入请求。 此外，Tile领导者使用Raft在Tile同行之间进行复制，以实现强一致性。 除了tablet领导者之外，Raft组中剩余的tablet对等体被称为tablet追随者。

CoreDB 更新集取决于用户发出的写入，并且涉及锁定一组键以建立严格的更新顺序，并可选择读取旧值以在读取-修改-写入操作的情况下进行修改和更新。 Raft 日志用于确保Tile的数据库状态机在Tile对等体之间进行复制，即使在出现故障或成员资格更改的情况下，也能保证严格的排序和正确性。 这对于实现强一致性至关重要。

当Raft日志被复制到大多数tablet-peers并在大多数上成功持久化后，写入将被应用到CoreDB文档存储层，随后可供读取。 当写入被文档存储层持久化到磁盘上后，可以从 Raft 日志中清除写入条目。 这是作为受控后台操作执行的，不会对前台操作产生任何影响。

## **主集群中的复制**

数据副本可以跨多个故障域放置。 以下具有三个可用区（zone）且复制因子假设为 3 的多可用区（zone）部署示例演示了如何在集群中执行跨故障域的复制。

**1.多可用区部署**
在多可用区部署的情况下，节点中每个Tile中的数据使用 Raft 共识算法跨多个可用区进行复制。 属于给定tablet的行的所有读取和写入查询均由该tablet的领导者处理，如下图所示：

![](../../assets/chapter9/27.png)

作为Raft复制的一部分，每个tablet对等体首先选举一个tablet领导者负责服务读取和写入。 不同Zone之间的Tablet Leader的分布是由用户指定的数据放置策略决定的，在前面的场景中，该策略确保在稳定状态下，每个Zone拥有相同数量的Tablet Leader。 下图显示了Tile领导者的分散情况：

![](../../assets/chapter9/28.png)

2.容忍（一个）可用区中断
一旦发生区域中断，AiSQL 就会假设该区域中的所有节点同时变得不可用。 这导致三分之一的Tile（其Tile领导者位于刚刚发生故障的区域）无法满足任何请求。 另外三分之二的Tile不受影响。 对于受影响的三分之一，AiSQL 自动执行故障转移到其他两个区域中的实例。 再次，进行故障转移的Tile均匀分布在剩余的两个区域中，如下图所示：

![](../../assets/chapter9/29.png)

追随者失败不会影响读写。 只有Tile领导者提供读取和写入服务。

3.可用区中断时的 RPO 和 RTO
每个Tile的恢复点目标 (RPO) 均为 0，这意味着在故障转移到另一个区域时不会丢失任何数据。 恢复时间目标 (RTO) 为 3 秒，这是完成故障转移并在新区域之外运行的时间窗口，如下图所示：

![](../../assets/chapter9/30.png)



## **追随者阅读**

只有Tile领导者可以处理面向用户的写入和读取请求。 请注意，虽然这是强一致性读取的情况，但 AiSQL 提供了具有宽松保证的追随者读取，这在某些部署模型中是需要的。 所有其他Tile对等点都称为追随者，仅复制数据。 它们可用作热备用，可以在领导者发生故障时快速接管。
