互联网和云技术已经彻底改变了人们的互动和操作方式，云引入了跨多个地理位置分发和复制数据的可能性，访问和维护全局分布的数据需要新的全局应用程序。

## **对全局应用程序的需求**

使应用程序全局化的原因与采用分布式数据库的原因相同：

* 业务连续性和灾难恢复。公共云已经取得了长足的进步，但区域和区域停机仍然相当常见，每年发生一到两次（例如，参见AWS停机和谷歌停机）。要向用户提供不间断的服务，您需要在多个位置运行应用程序。
* 用于法规遵从性的数据驻留。为了遵守数据保护法（例如GDPR），您需要确保公民的数据存储在其所在国家的服务器上。这意味着您需要设计相应的应用程序，以便在不同地区间拆分数据。
* 将数据移动到离用户更近的位置。在设计具有全局影响力的应用程序（例如，电子邮件、电子商务或奥运会等广播活动）时，您需要考虑用户的位置。如果您的应用程序托管在中国的数据中心，欧洲的用户在尝试访问您的应用软件时可能会遇到高延迟。为了提供最佳的用户体验，您需要在离用户更近的地方运行应用程序。 

### **应用程序设计模式**

在多个数据中心中运行应用程序并在这些数据中心之间拆分数据，这不是一项微不足道的任务。在设计全局应用程序时，您需要回答以下问题：

* 应用程序的多个实例将如何在不同的域（区域/数据中心）中运行？
* 应用程序实例是相同的还是不同的？
* 这些应用程序将如何跨地理位置部署？
* 每个实例是在整个数据集上操作，还是仅在数据的一个子集上操作？
* 是否允许冲突的应用程序更新？如果是，如何处理这些问题？
* 应用程序将如何发展？
* 在默认域出现故障时，应用程序将如何运行？

为了帮助您回答这些问题，请使用以下体系结构概念为您的应用程序选择合适的设计模式。

### **应用程序体系结构**

根据应用程序实例运行的位置和活动的应用程序实例，从以下应用程序体系结构中进行选择：

* 单活-一个区域（或默认域）中只有一个应用程序实例处于活动状态。数据必须放置在该应用程序附近。失败时，应用程序将移动到另一个区域
* 多活-应用程序在不同的区域运行，并在整个数据集上运行。
* 只读多活-只有一个应用程序实例处于活动状态，而其他应用程序实例可以提供过时的读取。
* 分区多活-多个应用程序在多个区域中运行，仅对一个子集的数据进行操作 

### **可用性体系结构**

根据应用程序实例是在整个数据集上运行还是仅在一个子集上运行，以及应用程序在默认域故障中的移动方式，从以下可用性体系结构中进行选择：

* 跟随应用程序—只有一个应用程序实例处于活动状态，而其他实例（一个或多个）可以提供过时的读取。
* 地理本地数据集-应用程序作用于地理位置的本地数据。出现故障时，应用程序不会移动

### **数据访问架构**

根据应用程序应该读取最新数据还是旧数据，从以下数据访问体系结构中进行选择：

* 一致性读-无论延迟或位置如何，都可以从真实的来源进行读取。
* Follower读-延时读，以实现更低的延迟读取。
* 副本读—允许旧数据的读取，但有旧数据的界限 

## **选择正确的模式**

根据上一节中描述的体系结构，使用以下矩阵选择设计模式 

| 模式类型 | 应用程序遵循               | 地理本地数据集     |
| -------- | -------------------------- | ------------------ |
| 单活     | 全局数据库 双活单主        |                    |
| 多活     | 全局数据库 重复索引        | 双活多主           |
| 只读多活 | 延迟优化的地理分区         | 局部优化的地理分区 |
| 分区多活 | 一致性读 Follower读 副本读 |                    |

## **设计模式**

下表总结了可用于应用程序的设计模式。使用这些经过验证的模式来解决常见问题并加快应用程序开发。

| 模式名             | 描述                                                         |
| ------------------ | ------------------------------------------------------------ |
| 全局数据库         | 分布在多个地区的单个数据库分布在多个（3个或更多）地区或区域中的数据库。失败时，另一个地区/区域中的复制副本将在几秒钟内升级为领导者，而不会丢失任何数据。应用程序从真正的来源进行读取，可能具有较高的延迟。 |
| 重复索引           | 任意地方数据都一致在多个区域中使用与表相同的架构设置覆盖索引，以在本地立即读取一致性的数据。 |
| 双活单主           | 可以提供读取服务的辅助数据库设置第二个异步填充的集群，以便在主集群出现故障时开始提供数据服务。 |
| 双活多主           | 两个集群一起提供数据服务。两个或多个区域，手动故障切换，几秒钟的数据丢失（非零RPO），低读/写延迟，事务保证的一些警告。 |
| 延迟优化的地理分区 | 快速本地访问对数据进行分区并放置，以便可以更快地访问属于附近用户的数据。 |
| 局部优化的地理分区 | 遵守当地法律对数据进行分区并放置数据，使属于不同用户的行位于他们各自的国家/地区。 |
| Follower读         | 快速、旧数据的读取从本地追随者那里读取，而不是去找其他地区的领导者进行读取。 |
| 读副本             | 从只读群集快速读取建立一个单独的追随者集群，进行本地读取，而不是去找不同地区的领导者进行读取。 |



## **图例**

本节中的所有插图都使用以下图例来表示Tile的领导者和追随者、云区域和区域以及应用程序。


![](../assets/chapter3/1.png)
