将所有 BSQL 数据库和角色备份到 SQL 脚本文件中。

## **概述**

bm-dumpall 是一个实用程序，用于将集群的所有 AiSQL 数据库写出（“转储”）到一个纯文本 SQL 脚本文件中。 该脚本文件包含可用作 sqlsh 的输入来恢复数据库的 SQL 语句。 它通过为 AiSQL 集群中的每个数据库调用 bm-dump 来完成此操作。 bm-dumpall 还转储所有数据库通用的全局对象，例如数据库角色。（bm-dump 不导出角色）

由于 bm-dumpall 从所有数据库读取表，因此您很可能必须以数据库超级用户身份进行连接才能生成完整的转储。 此外，您将需要超级用户权限来执行保存的脚本，以便能够添加角色和创建数据库。

SQL 脚本将被写入标准输出。 使用 -f|--file 选项或 shell 运算符将其重定向到文件中。

bm-dumpall 需要多次（每个数据库一次）连接到 AiSQL 集群。 如果您使用密码验证，则每次都会要求输入密码。 在这种情况下，拥有 ~/.pgpass 文件会很方便。

**安装**
bm-dumpall 随 AiSQL 一起安装，位于 AiSQL 主目录的 postgres/bin 目录中。

**在线帮助**
运行 bm-dumpall --help 显示在线帮助。

## **语法**

```
bm-dumpall [ <connection-option> ... ] [ <content-output-formation-option> ... ]
```

connection-option：请参阅连接选项。
content-output-format-option：请参阅内容和输出格式选项

## **内容和输出格式选项**

以下命令行选项控制输出的内容和格式。

-a, --data-only
仅转储数据，而不转储架构（数据定义）。

-c, --clean
包括 SQL 语句以在重新创建数据库之前清理（删除）数据库。 还添加了角色的 DROP 语句。

-E encoding, --encoding=encoding
以指定的字符集编码创建转储。 默认情况下，转储是以数据库编码创建的。 （获得相同结果的另一种方法是将 PGCLIENTENCODING 环境变量设置为所需的转储编码。）

-f 文件名, --file=文件名
将输出发送到指定文件。 如果省略，则使用标准输出。

-g, --globals-only
仅转储全局对象（角色），不转储数据库。

-o, --oids
将对象标识符 (OID) 转储为每个表的数据的一部分。 如果您的应用程序以某种方式（即在外键约束中）引用 OID 列，请使用此选项。 否则，不应使用此选项。

-O, --no-owner
不要输出语句来设置对象所有权以匹配原始数据库。 默认情况下，bm-dumpall 发出 ALTER OWNER 或 SET SESSION AUTHORIZATION 语句来设置创建的模式元素的所有权。 当脚本运行时，这些语句将失败，除非它是由超级用户（或拥有脚本中所有对象的同一用户）启动的。 要创建可由任何用户恢复的脚本，但会授予该用户所有对象的所有权，请指定 -O|--no-owner。

-r, --roles-only
仅转储角色，不转储数据库。

-s, --schema-only
仅转储对象定义（架构），而不转储数据。

-S 用户名, --superuser=用户名
指定禁用触发器时要使用的超级用户用户名。 仅当使用 --disable-triggers 时这才相关。 （通常，最好将其忽略，而是以超级用户身份启动生成的脚本。）

-v, --verbose
指定详细模式。 这会导致 bm-dumpall 将开始和停止时间输出到转储文件，并将进度消息输出到标准错误。 它还将在 bm-dump 中启用详细输出。

--version, -V
打印 bm-dumpall 版本并退出。

-x, --no-privileges, --no-acl
防止转储访问权限（GRANT 和 REVOKE 语句）。

--column-inserts, --attribute-inserts
将数据转储为具有显式列名称的 INSERT 语句（INSERT INTO table (column, ...) VALUES ...）。 这会让恢复变得非常缓慢； 它主要用于制作可加载到非 AiSQL 数据库中的转储。

--disable-dollar-quoting
此选项禁止对函数体使用美元引用，并强制使用 SQL 标准字符串语法对它们进行引用。

--disable-triggers
此选项仅在创建纯数据转储时相关。 它指示 bm-dumpall 包含在重新加载数据时临时禁用目标表上的触发器的语句。 如果您不想在数据重新加载期间调用表上的引用完整性检查或其他触发器，请使用此选项。

目前，为 --disable-triggers 发出的语句必须以超级用户身份完成。 因此，您还应该使用 -S|--superuser 指定超级用户名，或者最好小心地以超级用户身份启动生成的脚本。

--if-exists
使用条件语句（即添加 IF EXISTS 子句）删除数据库和其他对象。 除非还指定了 -c|--clean，否则此选项无效。

--inserts
将数据转储为 INSERT 语句（而不是 COPY 语句）。 这会让恢复变得非常缓慢； 它主要用于制作可加载到非 AiSQL 数据库中的转储。 请注意，如果您重新排列了列顺序，则还原可能会完全失败。 --column-inserts 选项更安全，但速度更慢。

--load-via-partition-root 
当转储表分区的数据时，使 COPY 或 INSERT 语句的目标是包含它的分区层次结构的根，而不是分区本身。 这会导致在加载数据时为每行重新确定适当的分区。 当在服务器上重新加载数据时，这可能很有用，其中行并不总是属于与原始服务器上相同的分区。 例如，如果分区列的类型为文本，并且两个系统对用于对分区列进行排序的排序规则具有不同的定义，则可能会发生这种情况。

--lock-wait-timeout=timeout 
不要永远等待在转储开始时获取共享表锁。 相反，如果无法在指定的超时时间内锁定表，则失败。 超时可以用 SET statements_timeout 接受的任何格式指定。 允许的值根据要转储的服务器版本而有所不同，但所有版本都接受整数毫秒。

--no-comments
不要转储comments。

--no-publications
不要转储出版。

--no-role-passwords 
不要转储角色的密码。 恢复后，角色将具有空密码，并且在设置密码之前，密码验证将始终失败。 由于指定此选项时不需要密码值，因此从目录视图 pg_roles 而不是 pg_authid 读取角色信息。 因此，如果对 pg_authid 的访问受到某些安全策略的限制，此选项也会有所帮助。 注意：AiSQL 使用 pg_roles 和 pg_authid 系统表来实现 PostgreSQL 兼容性。

--no-security-labels
不要转储安全标签。

--no-subscriptions
不要转储订阅。

--no-sync
默认情况下，bm-dumpall 等待所有文件安全写入磁盘。 此选项导致 bm-dumpall 无需等待即可返回，这速度更快，但意味着后续操作系统崩溃可能会使转储损坏。 通常，此选项有助于测试，但在从生产安装转储数据时不应使用。

--no-unlogged-table-data
不要转储未wal的表的内容。 该选项对于是否转储表定义（模式）没有影响； 它仅禁止转储表数据。

--quote-all-identifiers
强制引用所有标识符。 当从 AiSQL 主要版本与 bm-dumpall 版本不同的服务器转储数据库时，或者当打算将输出加载到不同主要版本的服务器时，建议使用此选项。 默认情况下，bm-dumpall 仅引用在其自己的主要版本中属于保留字的标识符。 在处理可能具有稍微不同的保留字集的其他版本的服务器时，这有时会导致兼容性问题。 使用 --quote-all-identifiers 可以防止此类问题，但代价是转储脚本难以阅读。

--use-set-session-authorization 
输出 SQL 标准 SET SESSION AUTHORIZATION 语句而不是 ALTER OWNER 语句来确定对象所有权。 这使得转储更加兼容标准，但根据转储中对象的历史记录，可能无法正确恢复。

-?, --help 
显示有关 bm-dumpall 命令行参数的帮助，然后退出。

## **连接选项**

以下命令行选项控制数据库连接参数。

-d connstr, --dbname=connstr
指定用于连接到服务器的参数，作为连接字符串。

该选项称为 -d|--dbname 是为了与其他客户端应用程序保持一致，但由于 bm-dumpall 需要连接到许多数据库，因此连接字符串中的数据库名称将被忽略。 使用 -l|--database 选项指定用于初始连接的数据库名称，这将转储全局对象并发现应转储哪些其他数据库。

-h 主机，--host 主机
指定运行数据库服务器的计算机的主机名。 如果该值以斜杠开头，则将其用作 Unix 域套接字的目录。 默认值取自 PGHOST 环境变量（如果已设置），否则将尝试 Unix 域套接字连接。

-l 数据库名称, --database=数据库
指定要连接的数据库的名称，以转储全局对象并发现应转储哪些其他数据库。 如果未指定，则将使用 bigmath 数据库，如果该数据库不存在，则将使用 template1。

-p 端口, --port=端口
指定服务器侦听连接的 TCP 端口或本地 Unix 域套接字文件扩展名。 默认为 PGPORT 环境变量（如果设置）或编译后的默认值。

-U 用户名, --username=用户名
连接的用户名。

-w, --无密码
切勿发出密码提示。 如果服务器需要密码身份验证，并且无法通过其他方式（例如 ~/.pgpass 文件）获得密码，则连接尝试将失败。 此选项在没有用户输入密码的批处理作业和脚本中非常有用。

-w, --no-password
强制 bm-dumpall 在连接到数据库之前提示输入密码。

该选项从来都不是必需的，因为如果服务器要求密码身份验证，bm-dumpall 会自动提示输入密码。 然而，bm-dumpall 会浪费一次连接尝试来发现服务器需要密码。 在某些情况下，值得输入 -W|--password 以避免额外的连接尝试。

注：对于每个要转储的数据库，都会出现密码提示。 为了避免每次都手动输入密码，您可以设置 ~/.pgpass 文件。

--role=rolename
指定用于创建转储的角色名称。 此选项导致 bm-dumpall 在连接到数据库后发出 SET ROLE <rolename> 语句。 当经过身份验证的用户（由 -U|--username 指定）缺乏 bm-dumpall 所需的权限，但可以切换到具有所需权限的角色时，这会很有帮助。 某些安装有禁止以超级用户身份直接登录的策略，使用此选项允许在不违反策略的情况下进行转储。

## **环境**

AiSQL 使用以下 PostgreSQL 环境变量（在某些 bm-dumpall 和 bm-dump 选项中引用）来实现 PostgreSQL 兼容性：

* PGHOST
* PGPORT
* PGOPTIONS
* PGUSER
* PGCLIENTENCODING

该实用程序还使用 libpq 支持的环境变量。

## **注意事项**

由于 bm-dumpall 在内部调用 bm-dump，因此一些诊断消息会引用 bm-dump。
即使您的目的是将转储脚本恢复到新的集群中， -c|--clean 选项也会很有帮助。 使用 -c|--clean 授权脚本删除并重新创建内置的 bigmath、postgres 和 template1 数据库，确保这些数据库将保留它们在源中具有的相同属性（例如，区域设置和编码） 簇。 如果没有该选项，这些数据库将保留其现有的数据库级属性以及任何预先存在的内容。
恢复后，建议对每个数据库运行 ANALYZE，以便优化器获得有用的统计信息。 您还可以运行vacuumdb -a -z 来分析所有数据库。
不应期望转储脚本能够完全无错误地运行。 特别是，由于脚本将为源集群中存在的每个角色发出 CREATE ROLE 语句，因此引导超级用户肯定会收到角色已存在错误，除非目标集群是使用不同的引导超级用户名称初始化的。 此错误是无害的，应该被忽略。 使用 -c|--clean 选项可能会产生有关不存在对象的额外无害错误消息，尽管您可以通过添加 --if-exists 来最小化这些错误消息。

## **示例**

转储所有数据库

```
$ ./postgres/bin/bm-dumpall > db.out
```

要从此文件重新加载数据库，您可以使用：

```
$ ./bin/sqlsh -f db.out bigmath
```

您连接的数据库并不重要，因为 bm-dumpall 创建的脚本文件将包含用于创建和连接到已保存数据库的适当语句。 一个例外是，如果指定 -c|--clean，则必须首先连接到 postgres 数据库； 该脚本将尝试立即删除其他数据库，而对于您连接到的数据库来说，这将失败。